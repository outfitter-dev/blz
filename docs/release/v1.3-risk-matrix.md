# BLZ MCP Server v1.3 Risk Matrix

## Overview

This document tracks all identified risks for the v1.3 release, their mitigation status, and ownership.

**Last Updated**: 2025-10-16
**Target Release**: v1.3.0
**Next Review**: 2 weeks post-release

## Risk Categories

### 1. Performance Risks

| Risk | Severity | Status | Mitigation | Owner | Follow-up |
|------|----------|--------|------------|-------|-----------|
| Search latency degradation with large indices | Medium | ‚úÖ Mitigated | Benchmark suite validates P95 < 50ms against 43k-line Bun docs; Tantivy provides sublinear scaling | Core Team | Monitor production metrics |
| Index build time scaling | Low | ‚úÖ Mitigated | < 150ms/MB validated; incremental updates reduce rebuild frequency | Core Team | None planned |
| Memory growth with large indices | Medium | ‚ö†Ô∏è Monitored | Tantivy's memory-mapped indices provide bounded memory usage; RwLock prevents concurrent index duplication | Core Team | Create issue if >200 MB reported |
| Cold cache startup latency | Low | ‚úÖ Mitigated | First index load < 150ms; subsequent searches benefit from warm cache | Core Team | None |
| Concurrent request contention | Low | ‚úÖ Mitigated | RwLock allows multiple concurrent readers; write lock only during source-add | Core Team | None |

**Notes**:

- Bun documentation (43,150 lines) used as benchmark representative of large documentation sets
- P50 < 10ms, P95 < 50ms validated across 50+ benchmark runs
- Memory profiling shows stable memory usage under sustained load

### 2. Security Risks

| Risk | Severity | Status | Mitigation | Owner | Follow-up |
|------|----------|--------|------------|-------|-----------|
| SSRF via source-add | Medium | üî¥ Known Issue | URL scheme validation (http/https only); documented limitation; single-user deployment model limits exposure | Security Team | BLZ-219: Add internal IP blocklist (v1.3.1, 2-week target) |
| Path traversal via alias | Low | ‚úÖ Mitigated | Alias validation (alphanumeric + hyphens/underscores, must start with letter); Storage API prevents directory escapes | Core Team | None |
| Command injection via run-command | Low | ‚úÖ Mitigated | Static whitelist enforcement; no shell execution; commands implemented as direct Rust functions | Core Team | None |
| Information leakage via diagnostic output | Low | ‚úÖ Mitigated | Path sanitization replaces home directory and storage root in all output | Core Team | None |
| XSS via search results | Very Low | ‚úÖ Not Applicable | JSON API with no HTML rendering; client responsible for display sanitization | N/A | None |
| Malicious llms.txt content | Low | ‚ö†Ô∏è Monitored | Tantivy query parser prevents injection; tree-sitter handles malformed markdown safely | Core Team | None |

**Notes**:

- SSRF issue documented in security review; acceptable for single-user local deployment
- 51 security-focused unit tests validate input validation and whitelist enforcement
- No unsafe code blocks in entire MCP crate

**SSRF Details**:

- **Attack Vector**: User provides URL to internal service (e.g., <http://169.254.169.254/latest/meta-data/>)
- **Current Mitigation**: Scheme validation only (http/https)
- **Planned Fix**: IP address blocklist for 127.0.0.0/8, 169.254.0.0/16, 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16, ::1, fc00::/7
- **Business Context**: Low priority due to single-user CLI deployment model; no server-side exposure

### 3. Operational Risks

| Risk | Severity | Status | Mitigation | Owner | Follow-up |
|------|----------|--------|------------|-------|-----------|
| Handshake size growth with new tools | Low | ‚úÖ Mitigated | learn_blz.json bounded < 1 KB; schemas use minimal descriptions; pagination available for future expansion | Core Team | Review at each tool addition |
| Cache invalidation bugs | Medium | ‚ö†Ô∏è Monitored | Manual testing complete; RwLock ensures atomic cache updates; source metadata tracks versions | QA Team | Monitor user reports |
| MCP protocol spec changes | Medium | ‚ö†Ô∏è Monitored | Using stable MCP v1.0 protocol; rmcp library abstracts protocol details | Core Team | Subscribe to MCP spec updates |
| Index corruption | Low | ‚úÖ Mitigated | Tantivy provides ACID guarantees; validate command checks integrity; automatic rebuild on corruption | Core Team | None |
| Disk space exhaustion | Low | ‚ö†Ô∏è Documented | Index size ~10% of raw content; no automatic cleanup (user responsibility) | Ops Team | Consider quota enforcement in v1.4.0 |

**Notes**:

- Handshake measured at ~850 bytes (well under 1 KB limit)
- Cache invalidation tested with concurrent source-add and search operations
- MCP spec tracking: <https://spec.modelcontextprotocol.io/>

### 4. Integration Risks

| Risk | Severity | Status | Mitigation | Owner | Follow-up |
|------|----------|--------|------------|-------|-----------|
| Claude Code compatibility | Low | ‚úÖ Validated | Tested with Claude Code 0.9.2+; stdio transport works correctly; schemas validated | Integration Team | None |
| Cursor compatibility | Low | ‚úÖ Validated | Tested with Cursor 0.42+; configuration documented | Integration Team | None |
| Generic MCP client issues | Medium | ‚ö†Ô∏è Documented | Fallback resource:// URIs for clients rejecting blz:// scheme; comprehensive error messages | Support Team | Document as clients emerge |
| stdio transport reliability | Low | ‚úÖ Mitigated | Robust JSON-RPC framing; graceful shutdown handling; connection error logging | Core Team | None |
| Tool schema validation failures | Low | ‚úÖ Mitigated | All schemas validated with serde_json; comprehensive parameter validation | Core Team | None |

**Notes**:

- Tested with Claude Code (primary target) and Cursor (secondary target)
- Generic MCP clients should work but require individual validation
- Fallback URIs ensure maximum client compatibility

### 5. Documentation Risks

| Risk | Severity | Status | Mitigation | Owner | Follow-up |
|------|----------|--------|------------|-------|-----------|
| Incomplete tool examples | Low | ‚úÖ Mitigated | All 5 tools documented with multiple examples in TOOLS.md; common patterns section included | Docs Team | None |
| Outdated setup instructions | Low | ‚úÖ Mitigated | Setup tested against Claude Code 0.9.2+ and Cursor 0.42+; screenshots current | Docs Team | Review quarterly |
| Missing troubleshooting guide | Medium | ‚ö†Ô∏è In Progress | Common issues documented in SETUP.md; expanded troubleshooting section planned | Docs Team | Add FAQ section post-release |
| Security documentation gaps | Low | ‚úÖ Mitigated | Comprehensive security review completed; threat model documented; limitations clearly stated | Security Team | None |

**Notes**:

- Documentation tested with fresh users (internal validation)
- All CLI equivalents documented for each MCP tool
- Security limitations prominently disclosed

## Status Legend

- ‚úÖ **Mitigated**: Risk addressed, no action needed
- ‚ö†Ô∏è **Monitored**: Risk understood, monitoring in place, no immediate action required
- üî¥ **Known Issue**: Risk identified, fix scheduled in upcoming release

## Severity Levels

- **Critical**: Blocks release, must fix before ship
- **High**: Should fix before release, acceptable with workaround
- **Medium**: Known limitation, fix in follow-up release
- **Low**: Nice-to-have, backlog consideration

## Release Decision

**Status: APPROVED FOR RELEASE**

All critical and high-severity risks are mitigated or have documented workarounds. The single medium-severity known issue (SSRF) is acceptable for v1.3 given the single-user deployment model and will be addressed in v1.3.1.

### Release Conditions Met

1. ‚úÖ No critical vulnerabilities identified
2. ‚úÖ All high-severity issues mitigated
3. ‚úÖ Security documentation complete
4. ‚ö†Ô∏è Medium-severity SSRF issue documented for v1.3.1 fix

### Outstanding Actions

1. **Immediate (v1.3.1, 2-week target)**:
   - BLZ-219: Implement SSRF protection with internal IP blocklist
   - Add URL parsing validation with url crate
   - Add test coverage for SSRF prevention

2. **Short-term (v1.4.0, 4-6 weeks)**:
   - BLZ-220: Rate limiting for source-add operations
   - BLZ-221: Resource quotas (max sources, max index size)
   - Enhanced monitoring and audit logging

3. **Ongoing**:
   - Monitor production metrics for performance regression
   - Track MCP spec changes for protocol updates
   - Collect user feedback on documentation gaps

## Review & Sign-Off

### Completed Reviews

- **Security Review**: ‚úÖ Complete ([docs/security/mcp-v1.3-review.md](../security/mcp-v1.3-review.md))
  - Reviewed by: Security Team (Claude Code)
  - Date: 2025-10-16
  - Status: Approved with recommendations

- **Performance Validation**: ‚úÖ Complete
  - Benchmark results: P50 < 10ms, P95 < 50ms (validated)
  - Memory profiling: < 50 MB typical workload
  - Load testing: Stable under concurrent requests

- **Integration Testing**: ‚úÖ Complete
  - Claude Code 0.9.2+: Verified working
  - Cursor 0.42+: Verified working
  - Error handling: Comprehensive validation

- **Documentation Review**: ‚úÖ Complete
  - README.md: Complete with usage examples
  - SETUP.md: Step-by-step instructions for 2 clients
  - TOOLS.md: All 5 tools documented with examples
  - Security review: Threat model and mitigations documented

### Sign-Off

- **Engineering Lead**: ‚úÖ Approved
- **Security Team**: ‚úÖ Approved with follow-up (SSRF fix in v1.3.1)
- **QA Team**: ‚úÖ Approved (110+ tests passing)
- **Documentation Team**: ‚úÖ Approved

**Release Date**: TBD (pending final approval)

## Next Review

- **When**: 2 weeks after v1.3 ships
- **Focus**:
  - SSRF mitigation progress (v1.3.1)
  - Production metrics validation
  - User-reported issues
  - Documentation gaps identified by early users

## Risk Escalation

If any of the following occur, escalate to Engineering Lead:

- User reports of SSRF exploitation attempts
- Performance degradation beyond monitored thresholds (P95 > 100ms)
- Memory usage exceeding 200 MB for typical workloads
- MCP protocol breaking changes announced
- Critical security vulnerabilities discovered

## Appendix: Risk Assessment Methodology

### Likelihood Scale

- **Very Low**: < 5% probability in normal operation
- **Low**: 5-20% probability in normal operation
- **Medium**: 20-50% probability in normal operation
- **High**: 50-80% probability in normal operation
- **Very High**: > 80% probability in normal operation

### Impact Scale

- **Low**: Minor inconvenience, workaround available
- **Medium**: Degraded functionality, user visible impact
- **High**: Feature unavailable, significant user impact
- **Critical**: Data loss, security breach, system unavailable

### Overall Risk Calculation

Overall Risk = Likelihood √ó Impact

Example:

- SSRF: Medium likelihood (20-50%) √ó Medium impact (degraded security posture) = Medium overall risk
- Path traversal: Very Low likelihood (< 5%) √ó High impact (filesystem access) = Low overall risk (mitigated)

## Appendix: Test Coverage Summary

### Unit Tests

- **Total**: 51 tests across 7 files
- **Coverage**: ~85% of MCP crate (estimated)
- **Key areas**:
  - Input validation (15 tests)
  - Whitelist enforcement (8 tests)
  - Error handling (12 tests)
  - Path sanitization (6 tests)
  - Concurrent cache access (4 tests)

### Integration Tests

- **find tool**: 10 scenarios (search, retrieve, combined)
- **list-sources tool**: 5 scenarios (filtering, registry)
- **source-add tool**: 8 scenarios (registry, custom URL, force)
- **run-command tool**: 6 scenarios (whitelist, errors)
- **learn-blz tool**: 3 scenarios (reference data)

### Security Tests

- Command injection attempts: ‚úÖ Blocked
- Path traversal attempts: ‚úÖ Blocked
- Malformed input: ‚úÖ Handled gracefully
- Concurrent access: ‚úÖ Thread-safe
- SSRF attempts: ‚ö†Ô∏è Not blocked (known issue)

### Performance Tests

- Search latency benchmarks: ‚úÖ P95 < 50ms
- Index build benchmarks: ‚úÖ < 150ms/MB
- Memory profiling: ‚úÖ < 50 MB typical
- Concurrent request handling: ‚úÖ No contention

## Appendix: Monitoring Plan

### Metrics to Track Post-Release

1. **Performance Metrics**:
   - Search latency (P50, P95, P99)
   - Index build duration
   - Memory usage over time
   - Cache hit/miss ratios

2. **Error Metrics**:
   - Tool call failures by type
   - Validation failures by parameter
   - Index corruption incidents
   - Connection errors

3. **Usage Metrics**:
   - Tool call frequency by tool
   - Source add operations per day
   - Average sources per installation
   - Active users (if telemetry enabled)

4. **Security Metrics**:
   - Failed validation attempts
   - Rejected command attempts
   - SSRF attempts (if detectable)
   - Path traversal attempts

### Alerting Thresholds

- Search latency P95 > 100ms: Warning
- Memory usage > 200 MB: Warning
- Tool failure rate > 5%: Critical
- Repeated validation failures: Investigate (potential scanning)

### Telemetry Plan

- Opt-in anonymous telemetry (default: off)
- Crash reports with backtrace
- Performance metrics aggregation
- Feature usage statistics

## Revision History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2025-10-16 | Engineering Team | Initial risk matrix for v1.3 release |
