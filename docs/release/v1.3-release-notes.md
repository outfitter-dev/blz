# BLZ MCP Server v1.3 Release Notes

## Overview

BLZ v1.3 introduces a Model Context Protocol (MCP) server implementation that enables AI agents to search and retrieve documentation from locally cached llms.txt sources with millisecond latency. The server provides 5 tools, custom blz:// URI resources, and a guided documentation discovery prompt.

This release focuses on read-only operations with a single intentional write capability (source-add) to maintain security by default while enabling essential documentation management.

## What's New in v1.3

### MCP Server Implementation

- **Full MCP v1.0 protocol support** via stdio transport
- **5 specialized tools** for documentation search, retrieval, and management
- **Custom blz:// URI resources** for source metadata and registry access
- **discover-docs guided prompt** for interactive documentation discovery
- **Read-only by default** with explicit write operations requiring user confirmation

### Tools Available

| Tool | Purpose | Mutates State |
|------|---------|---------------|
| `find` | Search documentation and retrieve exact content spans | No |
| `list-sources` | List installed sources and registry candidates | No |
| `source-add` | Add new documentation sources from registry or URL | Yes |
| `run-command` | Execute whitelisted diagnostic commands | No |
| `learn-blz` | Get BLZ reference data and usage examples | No |

#### find

Unified tool for searching documentation and retrieving exact line ranges:

- Full-text search across all indexed sources with BM25 ranking
- Precise line-range retrieval with configurable context expansion
- Support for multiple ranges in a single request
- Three context modes: none (exact lines), symmetric (full section), all (entire document)

#### list-sources

List documentation sources with filtering:

- Shows installed sources with metadata (line counts, fetch timestamps)
- Displays registry sources with suggested add commands
- Case-insensitive filtering by source name

#### source-add

Add documentation from registry or custom URL:

- Registry lookup for common documentation sources
- Custom URL support for private documentation
- Force flag to overwrite existing sources
- Automatic fetching, parsing, and indexing

#### run-command

Execute safe diagnostic commands:

- Whitelisted commands: stats, history, list, validate, inspect, schema
- Path sanitization in all output
- No shell execution or arbitrary command support

#### learn-blz

Returns curated reference data:

- Available prompts and their purposes
- Valid parameter values for tools
- Usage examples and patterns

### Resources

Custom `blz://` URI scheme provides structured access to:

- **blz://registry** - Complete registry of available documentation sources
- **blz://sources/{alias}** - Per-source metadata including URLs, fetch times, line counts

Fallback `resource://blz/` URIs supported for clients that reject custom schemes.

### Prompts

**discover-docs** - Interactive documentation discovery:

- Takes comma-separated list of technologies
- Returns three-message flow: installed sources, registry candidates, usage suggestions
- Keeps handshake payload under 1 KB
- Guides agents through documentation setup

## Performance Metrics

### Search Performance

- **P50 latency**: < 10ms (warm cache)
- **P95 latency**: < 50ms (warm cache)
- **Cold start**: < 150ms (first search after index load)
- **Index build**: < 150ms per MB of markdown

These metrics were validated against the Bun documentation source (43,150 lines, 1,926 headings).

### Resource Overhead

- **Handshake size**: < 1 KB (tool schemas, prompt definitions)
- **Memory footprint**: < 50 MB for typical workload (3-5 sources)
- **Disk overhead**: ~10% index size vs raw content (Tantivy's compressed indices)
- **Concurrent requests**: Thread-safe with RwLock-based index cache

## Security Model

### Read-Only by Default

All tools are read-only except `source-add`:

- `find` - Only reads indices and cached content
- `list-sources` - Only reads metadata
- `run-command` - Whitelist enforces read-only operations
- `learn-blz` - Returns static embedded JSON

### Command Whitelist

The `run-command` tool enforces strict command whitelist:

- Allowed: list, stats, history, validate, inspect, schema
- Rejected: All mutation commands (add, update, remove, delete)
- No shell execution or arbitrary command support

### Path Sanitization

All diagnostic command output sanitizes filesystem paths:

- Home directory (`/Users/alice`) replaced with `~`
- Storage root replaced with `<root>`
- Applied to both stdout and stderr

### Input Validation

Comprehensive validation across all tools:

- Alias validation: alphanumeric + hyphens/underscores, 1-64 chars
- URL validation: http:// or https:// schemes only
- Query validation: non-empty, bounded parameters
- Citation validation: format checks, range validation

### Known Limitations

- **SSRF protection**: URL validation doesn't prevent internal IP access (planned for v1.3.1)
- **Rate limiting**: No rate limiting on source-add operations (planned for v1.4.0)
- **Single-user model**: Assumes trusted client in user context

## Setup & Usage

### Quick Start

Add to Claude Code configuration (`claude_desktop_config.json`):

```json
{
  "mcpServers": {
    "blz": {
      "command": "blz",
      "args": ["mcp"]
    }
  }
}
```

For complete setup instructions including Cursor and other MCP clients, see [docs/mcp/SETUP.md](../mcp/SETUP.md).

### Documentation

- **Full guide**: [docs/mcp/README.md](../mcp/README.md)
- **Setup instructions**: [docs/mcp/SETUP.md](../mcp/SETUP.md)
- **Tool reference**: [docs/mcp/TOOLS.md](../mcp/TOOLS.md)
- **Security review**: [docs/security/mcp-v1.3-review.md](../security/mcp-v1.3-review.md)

## Verification Status

- ✅ Security review complete ([docs/security/mcp-v1.3-review.md](../security/mcp-v1.3-review.md))
- ✅ Performance benchmarks passing (P50 < 10ms, P95 < 50ms)
- ✅ 110+ tests passing across workspace
- ✅ Zero clippy warnings (strict workspace lints)
- ✅ Documentation complete (README, SETUP, TOOLS, security review)

## Breaking Changes

None - this is the initial MCP server release. Existing CLI functionality is unchanged.

## Known Issues

- **SSRF vulnerability** in `source-add`: URL validation doesn't prevent fetching from internal IP addresses (127.0.0.1, 169.254.169.254, etc.)
  - Mitigation: Document network requirements, single-user deployment model limits exposure
  - Fix: Planned for v1.3.1 (2-week target)

## Upgrade Path

This is the initial MCP release. No upgrade required.

To start using the MCP server:

1. Install or update BLZ CLI: `cargo install blz-cli`
2. Configure your MCP client (see [docs/mcp/SETUP.md](../mcp/SETUP.md))
3. Restart your MCP client

## Next Steps

### v1.3.1 (2-week target)

- Add SSRF protection with internal IP blocklist
- Improve URL validation with proper parsing
- Add test coverage for SSRF prevention

### v1.4.0 (planned)

- Rate limiting for source-add operations
- Resource quotas (max sources, max index size)
- Timeout enforcement for HTTP fetches
- Enhanced monitoring and audit logging

## Contributors

- Matt Galligan ([@galligan](https://github.com/galligan))
- Claude Code (AI pair programmer)

## Links

- **Repository**: <https://github.com/outfitter-dev/blz>
- **Documentation**: [docs/mcp/](../mcp/)
- **Security Review**: [docs/security/mcp-v1.3-review.md](../security/mcp-v1.3-review.md)
- **Issue Tracker**: <https://github.com/outfitter-dev/blz/issues>
