# BLZ CLI Verification Testing Report

**Test Date:** 2025-10-07
**BLZ Version:** 1.0.0-beta.1
**Test Environment:** macOS (Darwin 25.1.0)
**Binary:** /Users/mg/Developer/outfitter/blz/target/release/blz
**Test Source:** bun (43,150 lines, 1,926 headings)

---

## Executive Summary

**Overall Status:** PASS with notable findings

**Key Findings:**
- Performance claims verified: All searches <10ms
- Context expansion works correctly with boundary protection
- Multi-range retrieval works as expected
- Exit code inconsistency discovered in `get` command
- Empty query handling is permissive (returns empty results, not error)
- Out-of-range line requests return empty content silently (by design)

**Total Test Areas:** 14
**Tests Executed:** 50+
**Critical Issues:** 0
**Medium Issues:** 1 (exit code inconsistency)
**Low Issues:** 2 (documentation gaps)

---

## 1. Out-of-Range Line Handling

### Test Commands
```bash
blz get bun:50000-50010                    # Completely beyond bounds
blz get bun:43140-43160                    # Partially beyond (max=43150)
blz get bun:43150-43150                    # Exactly at boundary
blz get bun:43151-43160                    # Just beyond boundary
blz get bun:99999-100000 --format json     # Far beyond with JSON
```

### Observations
- **Completely out of range (50000-50010):** Returns empty content with `lineNumbers: []`, `content: ""`
- **Partially out of range (43140-43160):** Returns lines 43140-43150 (correctly clamped to max)
- **At boundary (43150):** Returns line 43150 correctly
- **Just beyond (43151-43160):** Returns empty content with `lineNumbers: []`
- **Text format:** Silently returns nothing (no output, no error)
- **JSON format:** Returns structured empty response

### Verdict
CONFIRMED - Behavior is intentional and consistent

### Details
The CLI gracefully handles out-of-range requests by:
1. Clamping partially overlapping ranges to valid bounds
2. Returning empty results for completely invalid ranges
3. No error messages (this appears intentional for scripting)

**Recommendation:** This is acceptable behavior, but could be documented in `--help` or error messages for clarity.

---

## 2. Non-Existent Source Behavior

### Test Commands
```bash
blz search "test" --source fakesource
blz search "test" --source fakesource --format json
blz get fakesource:1-10
blz get fakesource:1-10 --format json
blz validate fakesource
```

### Observations
- **Search command:** Returns empty results (exit 0), no error - silently ignores non-existent source filter
- **Get command:** Shows helpful error message: "Source 'fakesource' not found. Available: bun. Hint: 'blz list'..."
- **Get exit code:** Returns 0 (success) despite error message - INCONSISTENT
- **Validate command:** Shows error and returns exit code 1 - CORRECT

### Verdict
NUANCED - Inconsistent exit codes discovered

### Details
**Issue:** `blz get fakesource:1-10` prints an error message to stdout but exits with code 0.
- This violates the documented exit code convention (1 = user error)
- Makes it hard for scripts to detect failures
- `validate` command correctly returns exit 1 for non-existent sources

**Severity:** MEDIUM
**Recommendation:** Fix `get` command to return exit code 1 for non-existent sources

---

## 3. --prompt Flag Consistency

### Test Commands
```bash
blz search --prompt
blz get --prompt
blz add --prompt
```

### Observations
All commands return: `error: unexpected argument '--prompt' found`

### Verdict
N/A - Feature does not exist in v1.0.0-beta.1

### Details
The `--prompt` flag referenced in the initial testing request does not exist in this version. The equivalent functionality is provided by:
- `blz instruct` - Provides agent instructions for using blz
- `blz docs --format json` - Provides CLI documentation in JSON format

**Note:** This discrepancy suggests the initial report may have been testing a different version or branch.

---

## 4. Search Performance Verification

### Test Commands
```bash
# Basic search (5 runs): blz search "test" --format json
# Multi-term (5 runs): blz search "runtime async" --format json
# Common word (3 runs): blz search "the" --format json
```

### Observations
**Basic "test" search (5 runs):** 6, 6, 5, 5, 5 ms
**Multi-term "runtime async" (5 runs):** 7, 7, 7, 7, 7 ms
**Common word "the" (3 runs):** 7, 6, 6 ms

**Statistics:**
- Mean: 6.2 ms
- Median: 6 ms
- P95: ~7 ms
- Max observed: 7 ms

### Verdict
CONFIRMED - Exceeds performance claims

### Details
All searches completed well under the documented <10ms P50 target:
- P50: 6ms (target: <10ms) - PASS
- P95: 7ms - EXCELLENT
- No queries exceeded 10ms
- Query complexity had minimal impact on latency

**Note:** Testing was done with single source (43K lines). Performance may vary with multiple sources.

---

## 5. Empty Query Behavior

### Test Commands
```bash
blz search ""
blz search "" --format json
blz search "   "
blz search "   " --format json
```

### Observations
- Empty string: Returns `totalResults: 0`, `searchTimeMs: 0-1`
- Whitespace only: Returns `totalResults: 0`, `searchTimeMs: 0-1`
- No error message
- Exit code: 0

### Verdict
CONFIRMED - Permissive behavior

### Details
Empty queries are accepted and return empty results rather than errors. This is:
- **Good for scripting:** Non-breaking behavior
- **Potentially confusing:** Users might not realize their query was empty
- **Consistent:** Same behavior across text and JSON formats

**Recommendation:** Consider adding a warning in verbose mode for empty queries.

---

## 6. Context Expansion Accuracy

### Test Commands
```bash
blz get bun --lines 100-105 --context 0|1|3|10
blz get bun --lines 5-10 --context 10    # Near start
blz get bun --lines 43145-43150 --context 10  # Near end
```

### Observations
| Context | Range Input | Expected Output | Actual Output | Lines | Status |
|---------|-------------|-----------------|---------------|-------|--------|
| 0 | 100-105 | [100, 105] | [100, 105] | 6 | PASS |
| 1 | 100-105 | [99, 106] | [99, 106] | 8 | PASS |
| 3 | 100-105 | [97, 108] | [97, 108] | 12 | PASS |
| 10 | 100-105 | [90, 115] | [90, 115] | 26 | PASS |
| 10 | 5-10 | [1, 20] | [1, 20] | 20 | PASS (clamped at 1) |
| 10 | 43145-43150 | [43135, 43150] | [43135, 43150] | 16 | PASS (clamped at 43150) |

### Verdict
CONFIRMED - Perfect accuracy

### Details
Context expansion works exactly as documented:
- Expands symmetrically (±N lines)
- Correctly clamps at document boundaries
- Never goes below line 1
- Never exceeds max line count

**Note:** When context would go negative (e.g., line 5 - 10 = -5), it clamps to 1, resulting in asymmetric expansion. This is correct behavior.

---

## 7. Multi-Range Retrieval

### Test Commands
```bash
blz get bun --lines "100-105,110-115,120-125" --format json
blz get bun --lines "100-105,110-115" --format json
```

### Observations
- **Three ranges (100-105,110-115,120-125):**
  - Returned: `[100,101,102,103,104,105,110,111,112,113,114,115,120,121,122,123,124,125]`
  - Total lines: 18
  - Gaps properly excluded: 106-109, 116-119

- **Two ranges (100-105,110-115):**
  - Returned: `[100,101,102,103,104,105,110,111,112,113,114,115]`
  - Total lines: 12
  - Gap excluded: 106-109

### Verdict
CONFIRMED - Works perfectly

### Details
Multi-range syntax works as expected:
- Ranges are parsed correctly
- Gaps between ranges are excluded
- Line numbers in output maintain order
- Content concatenates cleanly

---

## 8. Pagination Determinism

### Test Commands
```bash
blz search "runtime" --limit 5 --format json  # Run 3 times
blz search "runtime" --limit 3 --page 1 --format json
blz search "runtime" --limit 3 --page 2 --format json
```

### Observations
**Same query, 3 runs:**
- Run 1: bun:16394-16394
- Run 2: bun:16394-16394
- Run 3: bun:16394-16394

**Pagination:**
- Page 1: `["16394-16394","4564-4564","2031-2031"]`
- Page 2: `["26581-26582","21130-21130","2999-2999"]`

### Verdict
CONFIRMED - Fully deterministic

### Details
Results are:
- **Deterministic:** Same results across runs
- **Consistent:** Pagination returns different results per page
- **Stable:** BM25 scoring produces consistent rankings

This is critical for:
- Reproducible searches
- Reliable pagination
- Predictable agent behavior

---

## 9. Deprecated Flags and Edge Cases

### Test Commands
```bash
blz search "test" --output json
blz search "test" -o json
blz get bun --lines "105-100"
blz get bun --lines "0-10"
blz get bun --lines "-5--1"
```

### Observations
**Deprecated flags:**
- `--output json`: Shows warning, works correctly
- `-o json`: Shows warning, works correctly
- Warning message: "warning: --output/-o is deprecated; use --format/-f. This alias will be removed in a future release."

**Invalid ranges:**
- `105-100` (reversed): Error: "Invalid range: 105-100" (exit 1) - GOOD
- `0-10` (includes 0): Error: "Line numbers must be >= 1" (exit 1) - GOOD
- `-5--1` (negative): Argument parsing error (exit 2) - EXPECTED

### Verdict
CONFIRMED - Good validation

### Details
- Deprecated flag warnings are clear and actionable
- Range validation is comprehensive
- Error messages are helpful
- Line numbering is correctly 1-indexed

---

## 10. Search Syntax Edge Cases

### Test Commands
```bash
blz search 'NOT test'
blz search 'test OR async'
blz search 'test AND async'
blz search '(test OR async) AND runtime'
blz search 'title:bun'
```

### Observations
- **NOT operator:** Returns 0 results (supported but may not work as expected)
- **OR operator:** Returns 150 results (works)
- **AND operator:** Returns 21 results (works)
- **Nested query:** Returns 0 results (parentheses may not be supported)
- **Field-specific:** Returns results (field queries work)

### Verdict
PARTIAL - Some operators work, others don't

### Details
**Working operators:**
- `OR` - explicit OR operator
- `AND` - explicit AND operator (same as `+term`)
- Field-specific queries (e.g., `title:bun`)

**Unclear/Not working:**
- `NOT` - returns 0 results (may not be supported)
- Parentheses `()` - nested queries return 0 results

**Recommendation:** Document supported query syntax in `blz search --help`.

---

## 11. Output Format Variations

### Test Commands
```bash
blz search "test" --format jsonl
blz search "test" --format text
blz list --format text
blz get bun --lines 100-105 --format text
```

### Observations
**JSONL format:** One JSON object per line, no array wrapper - CORRECT
**Text format (search):** Human-readable with rank indicators, snippets, breadcrumbs
**Text format (list):** Compact summary with key stats
**Text format (get):** Line-numbered output with `|` separator

### Verdict
CONFIRMED - All formats work correctly

### Details
All output formats are:
- **Valid:** JSON/JSONL parses correctly
- **Readable:** Text format is clear and well-formatted
- **Consistent:** Same data, different presentations
- **Documented:** Format behavior matches expectations

---

## 12. --quiet Flag

### Test Commands
```bash
blz search "test" --quiet --format json | jq -r '.totalResults'
blz list --quiet --format json | jq -r '.[0].alias'
```

### Observations
- Both commands work correctly
- JSON output is clean (no extra logging)
- Exit codes unchanged

### Verdict
CONFIRMED - Works as expected

### Details
`--quiet` flag successfully:
- Suppresses informational messages
- Keeps JSON output clean
- Useful for scripting and piping

---

## 13. Exit Codes

### Test Commands
```bash
blz search "test"           # Expected: 0
blz get fakesource:1-10     # Expected: 1 (user error)
blz get bun --lines "invalid"  # Expected: 1 (user error)
blz list                    # Expected: 0
blz validate fakesource     # Expected: 1 (user error)
```

### Observations
| Command | Expected | Actual | Status |
|---------|----------|--------|--------|
| search "test" | 0 | 0 | PASS |
| get fakesource:1-10 | 1 | 0 | FAIL |
| get --lines "invalid" | 1 | 1 | PASS |
| list | 0 | 0 | PASS |
| validate fakesource | 1 | 1 | PASS |

### Verdict
PARTIAL - Inconsistency found

### Details
**Issue:** `blz get fakesource:1-10` prints error message but exits with 0.
- This is the same issue identified in Test #2
- Only affects `get` command with non-existent source
- All other error conditions return correct exit codes

**Severity:** MEDIUM - Breaks scripting conventions

---

## 14. Additional Commands

### Test Commands
```bash
blz history --format json
blz config --format json
blz docs --format json
blz stats --format json
blz info bun --format json
blz doctor --format json
blz lookup react --format json
```

### Observations
- **history:** Returns array of recent searches - WORKS
- **config:** Returns config object with 13 keys - WORKS
- **docs:** Returns comprehensive CLI docs - WORKS
- **stats:** Returns cache statistics - WORKS
- **info:** Returns detailed source info - WORKS
- **doctor:** Returns health check results - WORKS
- **lookup:** Temporarily disabled with helpful message - EXPECTED

### Verdict
CONFIRMED - All commands functional

### Details
All tested commands:
- Return valid JSON when requested
- Provide useful information
- Have consistent interface
- Work with `--quiet` flag

---

## Issues Summary

### MEDIUM Priority

#### Issue #1: Exit Code Inconsistency in `get` Command
**Severity:** MEDIUM
**Command:** `blz get <non-existent-source>:<range>`
**Expected:** Exit code 1 (user error)
**Actual:** Exit code 0 (success)
**Impact:** Breaks error detection in scripts

**Steps to reproduce:**
```bash
blz get fakesource:1-10
echo $?  # Returns 0, should return 1
```

**Suggested fix:**
In `crates/blz-cli/src/commands/get.rs`, ensure non-existent source errors return exit code 1.

### LOW Priority

#### Issue #2: Empty Query Behavior Not Documented
**Severity:** LOW
**Command:** `blz search ""`
**Expected:** Either error or documented behavior
**Actual:** Returns empty results silently

**Recommendation:**
Document in `blz search --help` that empty queries return zero results.

#### Issue #3: Query Syntax Not Fully Documented
**Severity:** LOW
**Command:** `blz search <query>`
**Issue:** Unclear which operators are supported (NOT, parentheses, etc.)

**Recommendation:**
Add query syntax documentation to `blz search --help` or reference docs.

---

## Edge Cases Tested

PASS - Context expansion at document boundaries
PASS - Multi-range with gaps
PASS - Out-of-range line numbers (partially overlapping)
PASS - Out-of-range line numbers (completely invalid)
PASS - Empty query strings
PASS - Whitespace-only queries
PASS - Reversed ranges (105-100)
PASS - Zero-indexed lines (0-10)
PASS - Negative line numbers
PASS - Non-existent source in search filter (silently ignored)
PASS - Non-existent source in get command (error shown)
PARTIAL - Query operators (OR/AND work, NOT/parentheses unclear)
PASS - Deprecated flags (show warnings, still work)

---

## Integration Testing

### Workflow 1: Add → Search → Get
```bash
blz add bun https://bun.sh/llms-full.txt -y
blz search "runtime" --source bun --format json | jq -r '.results[0]'
blz get bun --lines "16394-16394" --context 5
```
**Result:** PASS - Complete workflow works seamlessly

### Workflow 2: Search → Multiple Pages
```bash
blz search "async" --limit 10 --page 1
blz search "async" --limit 10 --page 2
```
**Result:** PASS - Pagination works correctly

### Workflow 3: Multi-Source Search (simulated)
```bash
blz search "test" --format json  # Searches all sources
blz search "test" --source bun --format json  # Filters to one
```
**Result:** PASS - Source filtering works

---

## Performance Observations

**Search Performance:**
- P50: ~6ms (target: <10ms) - EXCELLENT
- P95: ~7ms - EXCELLENT
- Max observed: 7ms
- No outliers detected

**Command Startup:**
- Typical: <50ms
- Very fast for CLI tool

**Index Loading:**
- Transparent to user
- No perceptible delay

---

## Recommendations

### High Priority
1. **Fix exit code inconsistency** in `get` command for non-existent sources
2. **Verify exit code behavior** across all error conditions
3. **Add exit code tests** to prevent regression

### Medium Priority
1. **Document query syntax** - which operators are supported?
2. **Document empty query behavior** - is it intentional?
3. **Consider adding warnings** for potentially confusing inputs (empty queries, etc.)

### Low Priority
1. **Add examples** to `--help` output for complex features (multi-range, context expansion)
2. **Consider adding** `--strict` mode that errors on empty queries
3. **Document out-of-range behavior** in get command help text

---

## Comparison with Initial Report

**Note:** The initial testing request referenced `blz-dev` and a `--prompt` flag that don't exist in v1.0.0-beta.1. This suggests:
- Initial report may have tested a development branch
- Or tested a different version
- This verification tested the current release candidate (v1.0.0-beta.1)

**Findings confirmed from initial report:**
- Out-of-range line handling (confirmed as intentional)
- Performance <10ms (confirmed and exceeded)
- Multi-range support (confirmed working)

**Discrepancies with initial report:**
- `--prompt` flag does not exist (used `blz instruct` instead)
- `blz-dev` binary does not exist (used `blz`)

---

## Conclusion

The BLZ CLI v1.0.0-beta.1 is in excellent condition:

**Strengths:**
- Exceptional performance (6ms P50 search)
- Robust error handling (mostly)
- Comprehensive feature set
- Clear, helpful error messages
- Consistent output formats
- Deterministic search results

**Areas for improvement:**
- Exit code inconsistency in `get` command (medium priority)
- Query syntax documentation gaps (low priority)
- Empty query behavior documentation (low priority)

**Overall Assessment:** PASS with minor issues

The CLI is production-ready with one recommended fix (exit codes) before final release.

---

**Test Coverage:** Comprehensive
**Documentation Quality:** Good
**Error Handling:** Very good (minus exit code issue)
**Performance:** Excellent
**User Experience:** Excellent

**Recommendation:** Fix exit code issue, then proceed with release.
