# v0.5.0 Release Branch — Work Log

**Branch**: `gt/v0.5-release`
**Status**: ✅ Ready for release
**Last Updated**: 2025-10-01

## Overview

This branch implements v0.5.0 which simplifies the dual-flavor system by always preferring `llms-full.txt` when available, eliminating user-facing flavor complexity.

**Key Changes**:
- Feature flag to prefer llms-full.txt (FORCE_PREFER_FULL)
- Upgrade command to migrate llms.txt → llms-full.txt
- Alias terminology refactoring (alias→source fields)
- Registry system with 22 verified sources
- `blz add --dry-run` for source analysis
- `blz registry create-source` command
- Accurate heading counts (recursive TOC counting)
- 404 placeholder page filtering

## Branch Status

**Commits on this branch**:
1. `a14c373` - feat: add FORCE_PREFER_FULL feature flag
2. `80e765d` - feat: implement upgrade command
3. `cada35a` - feat: add registry system with 32 sources
4. `303ac00` - refactor: rename alias→source fields, add --aliases flag
5. `0f6bf56` - fix: normalize heading counts and filter placeholder pages

**Tests**: ✅ All 224 tests passing
**Remote**: Pushed to `origin/gt/v0.5-release`

---

## 1. Feature Flag Implementation (Commit a14c373)

### Problem
Dual-flavor system (llms.txt vs llms-full.txt) caused complexity:
- Text formatter flavor mismatches (bug #232)
- Hidden --flavor flags requiring configuration
- Poor default behavior

### Solution
Added `FORCE_PREFER_FULL` constant in `crates/blz-cli/src/utils/flavor.rs` that overrides all flavor resolution to prefer llms-full.txt first.

**Benefits**:
- Low risk (easy rollback)
- No breaking changes
- Immediate UX improvement

**Files Modified**: 2 files, 7 insertions

---

## 2. Upgrade Command (Commit 80e765d)

### Implementation
New `blz upgrade` command migrates sources from llms.txt to llms-full.txt:

```bash
blz upgrade <source>     # Upgrade specific source
blz upgrade --all        # Upgrade all sources
blz upgrade --yes        # Skip confirmation
```

**Features**:
- Discovers sources using llms.txt
- Checks if llms-full.txt available upstream
- Prompts for confirmation (unless --yes)
- Fetches, parses, and indexes llms-full.txt
- Maintains backward compatibility

**Files Modified**: 8 files, 311 lines (new upgrade.rs module)

**Tests**: 5 comprehensive tests added

---

## 3. Registry System (Commit cada35a)

### Infrastructure
Created registry infrastructure with 22 verified sources:

**Categories**:
- AI/LLM (3): ai-sdk, langchain, mastra
- Runtimes (2): bun, deno
- Frameworks (4): astro, expo, svelte, vue
- UI Libraries (5): ant-design, chakra-ui, mui, preact, vite
- Database/ORM (4): drizzle, pinecone, prisma, redis
- Platforms (3): cloudflare, supabase, vercel
- Tools (2): cursor, vite

**New Files**:
- `registry/sources/*.toml` - 22 source definitions
- `registry/scripts/build.sh` - TOML → JSON compiler
- `registry/scripts/check-urls.sh` - URL validation
- `crates/blz-registry-build/` - Registry builder binary
- `registry.json` - Generated registry (600 lines)

---

## 4. Dry-Run Analysis (Commit cada35a)

### Feature
Added `--dry-run` flag to `blz add`:

```bash
blz add <name> <url> --dry-run
```

**Output** (JSON):
```json
{
  "name": "ai-sdk",
  "url": "https://sdk.vercel.ai/llms.txt",
  "finalUrl": "https://sdk.vercel.ai/llms-full.txt",
  "analysis": {
    "lineCount": 35260,
    "charCount": 1500000,
    "headerCount": 250,
    "sections": 180,
    "fileSize": "1.5 MB",
    "contentType": "full"  // "full" | "index" | "mixed"
  },
  "wouldIndex": true
}
```

**Content Type Classification**:
- `"full"` - Files >1000 lines (comprehensive docs)
- `"index"` - Files <100 lines (TOC/links only)
- `"mixed"` - Files 100-1000 lines (gray area)

---

## 5. Registry Create-Source Command (Commit cada35a)

### Implementation
New `blz registry create-source` command:

```bash
blz registry create-source <name> --url <url> [OPTIONS]
```

**Options**:
- `--description <TEXT>` - Source description
- `--category <CATEGORY>` - Category (library, framework, runtime, etc.)
- `--tags <TAG1,TAG2>` - Comma-separated tags
- `--npm <PKG1,PKG2>` - NPM package names
- `--github <ORG/REPO>` - GitHub repositories
- `--add` - Also index locally after creating registry entry
- `-y, --yes` - Skip confirmation prompts

**Workflow**:
1. Analyzes source via `blz add --dry-run`
2. Warns if contentType is "index" (TOC-only)
3. Prompts for missing metadata (interactive mode)
4. Creates `registry/sources/<name>.toml`
5. Rebuilds `registry.json`
6. Optionally indexes locally with `--add`

**Files Modified**: 4 files, 399 lines (new create_source.rs module)

---

## 6. Alias Terminology Refactoring (Commit 303ac00)

### Problem
Term "alias" was overloaded to mean two different things:
1. Canonical identifier (primary name)
2. Metadata aliases (alternate names)

### Solution
Standardized terminology:
- **"source"** = canonical identifier
- **"aliases"** = metadata aliases (alternate names)

**Core Type Changes**:

```rust
// Before
pub struct LlmsJson {
    pub alias: String,      // Canonical identifier
    pub source: Source,     // Metadata struct
}

// After
pub struct LlmsJson {
    pub source: String,     // Canonical identifier
    pub metadata: Source,   // Metadata struct
}
```

**New Feature**: `--aliases` flag for `blz add`:

```bash
blz add ai-sdk https://sdk.vercel.ai/llms.txt \
  --aliases "ai,vercel-ai,@ai-sdk/core"
```

**CLI Help Text Updates**:
- Add: "Source name (used as identifier)"
- Get: "Source (or alias) to retrieve from"
- Update: "Source to update"

**Files Modified**: 21 files (~150 insertions, ~150 deletions)

**Tests**: ✅ All 224 tests passing

---

## 7. Heading Count & 404 Filtering (Commit 0f6bf56)

### Cherry-Picked Fixes
Manually applied from `gt/fix-normalize-heading-counts-and-filter-placeholder-pages` branch (avoiding flavor-related conflicts).

**1. Accurate Heading Counts**:
- Created `count_headings()` utility that recursively counts all headings
- Previously used `.toc.len()` which only counted top-level entries
- New module: `crates/blz-cli/src/utils/toc.rs` (42 lines with tests)

**2. 404 Placeholder Filtering**:
- Parser detects and skips placeholder "404" pages
- Prevents them from capturing subsequent sections in TOC
- Added test: `test_skips_placeholder_404_headings()`

**3. Baseline Level Normalization**:
- Handles documents that don't start at heading level 1
- Tracks baseline level and normalizes all headings accordingly

**Files Modified**: 6 files (+115, -5 lines)

**Tests**: ✅ All 140 core tests + toc tests passing

---

## Documentation Updates

### Updated Files
- `docs/commands/search.md` - Removed flavor section, added upgrade guidance
- `docs/commands/update.md` - Simplified, removed --flavor flags
- `docs/commands/upgrade.md` - NEW file documenting upgrade command
- `README.md` - Updated 3 sections for simplified messaging

### CLI Improvements
- Tombstoned `--flavor` flags (hidden but still accepted)
- Added deprecation notices in doc comments
- Consistent "source" terminology throughout help text

---

## Migration Notes for Future Development

### Terminology
- Always use "source" for canonical identifiers
- Reserve "alias" for metadata aliases only
- Function parameters: `source: &str` not `alias: &str`

### Feature Flag
- `FORCE_PREFER_FULL` constant in `crates/blz-cli/src/utils/flavor.rs:24`
- Set to `true` for v0.5.0
- Future cleanup PRs can remove flavor infrastructure entirely

### Registry
- 22 sources seeded and verified
- Use `blz registry create-source` to add new sources
- All URLs validated with redirect following

---

## Performance & Quality

**Compilation**: ✅ Clean (1 unused function warning in http.rs)
**Tests**: ✅ 224/224 passing
**Lints**: ✅ All clippy checks passing
**Pre-commit**: ✅ rustfmt, cargo check, commitlint, yaml_format

**Test Coverage**:
- Unit tests: 81 (blz-cli) + 139 (blz-core)
- Integration tests: 4
- New tests: 5 for upgrade, toc counting, 404 filtering

---

## Release Readiness

✅ **Feature Complete**: All v0.5.0 features implemented
✅ **Tests Passing**: 224/224 tests passing
✅ **Documentation**: Updated for simplified UX
✅ **Backward Compatible**: No breaking changes
✅ **Registry Seeded**: 22 verified sources
✅ **Branch Pushed**: `origin/gt/v0.5-release`

**Next Steps**:
1. Create PR when ready for review
2. Address any reviewer feedback
3. Merge to main
4. Tag v0.5.0 release
5. Update changelog
