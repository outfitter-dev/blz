# GitHub Issue: Startup Script Fails in Restricted Network Environments

**Title:** `fix(dx): startup script fails in restricted network environments`

**Labels:** `bug`, `dx`, `agent-setup`

---

## Problem

The startup script (`scripts/setup-agent-universal.sh`) fails in environments with restricted network access, blocking critical development workflows.

## Observed Failures

When running the startup script in Claude Code environment:

### 1. Cargo Operations Fail (403 Forbidden)
```
error: failed to get `anyhow` as a dependency of package `blz-core v1.3.0`
Caused by:
  download of config.json failed
Caused by:
  failed to get successful HTTP response from `https://index.crates.io/config.json` (21.0.0.153), got 403
  body: Access denied
```

### 2. Bun Installation Fails
```
curl: (22) The requested URL returned error: 403
[warn] Bun install failed
```

### 3. Git Hooks Fail
Pre-commit and pre-push hooks fail because they depend on cargo operations:
- `cargo_check` → 403 error
- `clippy_basic` → 403 error
- `clippy_strict` → 403 error
- `tests` → 403 error

## Impact

**Severity: High**

- Developers cannot commit changes (pre-commit hooks fail)
- Developers cannot push changes (pre-push hooks fail)
- Workaround requires bypassing hooks with `LEFTHOOK=0` or `--no-verify`
- This defeats the purpose of automated quality checks

## Environment

- Platform: Linux 4.4.0
- Agent: claude-code
- Branch: `claude/verify-startup-script-011CUKE2U1H65EfaDAFG3e4w`
- Network: Restricted (403 on crates.io, bun.sh)

## Proposed Solutions

### Option 1: Graceful Degradation
Modify startup script to handle network failures gracefully:
- Skip `cargo fetch` if network unavailable
- Mark hooks as "degraded mode" vs failing hard
- Allow commits/pushes with warning instead of blocking

### Option 2: Offline Mode
Add `--offline` flag support:
```bash
AGENT_OFFLINE_MODE=1 ./scripts/setup-agent-universal.sh
```
- Skip all network operations
- Assume dependencies already cached
- Configure git hooks to work offline

### Option 3: Network Detection
Auto-detect network restrictions and adapt:
```bash
# Test network before attempting operations
if ! curl -s -o /dev/null -w "%{http_code}" https://crates.io > /dev/null; then
  warn "Restricted network detected, enabling offline mode"
  export CARGO_NET_OFFLINE=true
fi
```

### Option 4: Conditional Hook Requirements
Make hook checks conditional based on environment:
```yaml
# lefthook.yml
pre-commit:
  commands:
    cargo_check:
      skip:
        - env: SKIP_CARGO_CHECKS=1
```

## Acceptance Criteria

- [ ] Startup script completes successfully in restricted networks
- [ ] Git hooks allow commits/pushes (with warnings if checks skipped)
- [ ] Clear messaging about degraded mode vs full mode
- [ ] Documentation updated with offline/restricted network instructions

## Related

- Affects: `.claude/settings.json` SessionStart hook
- Affects: `scripts/setup-agent-universal.sh`
- Affects: `lefthook.yml` hook configuration
- Affects: All agent environments (Factory, Devin, Codex, Conductor, Claude Code)

## Reproduction

1. Set up environment with restricted network (blocks crates.io)
2. Run: `./scripts/setup-agent-universal.sh`
3. Observe: cargo fetch failures
4. Attempt: `git commit`
5. Observe: pre-commit hook blocks commit
6. Workaround: `git commit --no-verify` (bypasses all checks)

---

**To create this issue:**
```bash
gh issue create \
  --title "fix(dx): startup script fails in restricted network environments" \
  --body-file .github-issue-draft.md \
  --label "bug,dx,agent-setup"
```
