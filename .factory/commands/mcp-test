#!/usr/bin/env bash
set -euo pipefail

# MCP Server Testing and Validation Script
# Usage: /mcp-test [server-name]

echo "ðŸ”§ Testing MCP server configuration..."

SERVER_NAME="${1:-}"

# Check if Factory CLI has MCP support
if ! command -v factory &> /dev/null; then
    echo "âš ï¸  Factory CLI not found. Running basic validation only."
    echo "   (Full MCP testing requires Factory CLI with MCP support)"
    FACTORY_AVAILABLE=false
else
    FACTORY_AVAILABLE=true
fi

# Test MCP configuration
echo "ðŸ“‹ Current MCP server configuration:"
if [ -f ".mcp.json" ]; then
    echo "âœ… .mcp.json found"
    jq '.' .mcp.json 2>/dev/null || {
        echo "âŒ .mcp.json is invalid JSON"
        exit 1
    }
else
    echo "âŒ .mcp.json not found"
    exit 1
fi

# Check environment variables
echo ""
echo "ðŸ” Environment variable check:"

# Check for Linear API key
if [ -n "${LINEAR_API_KEY:-}" ]; then
    echo "âœ… LINEAR_API_KEY is set"
else
    echo "âš ï¸  LINEAR_API_KEY not set (required for Linear MCP server)"
fi

# Check for Node.js/npx (required for Linear MCP server)
if command -v npx &> /dev/null; then
    echo "âœ… npx is available"
    NPX_VERSION=$(npx --version)
    echo "   Version: $NPX_VERSION"
else
    echo "âŒ npx not found (required for Linear MCP server)"
fi

# Check for blz CLI (required for blz-docs MCP server)
if command -v blz &> /dev/null; then
    echo "âœ… blz CLI is available"
    BLZ_VERSION=$(blz --version)
    echo "   Version: $BLZ_VERSION"
    
    # Check if blz has any sources configured
    SOURCE_COUNT=$(blz list --json 2>/dev/null | jq '. | length' || echo "0")
    echo "   Configured sources: $SOURCE_COUNT"
else
    echo "âš ï¸  blz CLI not found (required for blz-docs MCP server)"
fi

echo ""
echo "ðŸ§ª MCP Server-specific tests:"

if [ -n "$SERVER_NAME" ]; then
    echo "Testing specific server: $SERVER_NAME"
    
    case "$SERVER_NAME" in
        "linear-server")
            echo "ðŸ” Testing Linear MCP server..."
            if [ -z "${LINEAR_API_KEY:-}" ]; then
                echo "âš ï¸  LINEAR_API_KEY not set (may be required for authentication)"
                echo "   Note: SSE endpoint may work without API key for some operations"
            fi
            
            # Test SSE endpoint availability
            echo "ðŸ“¦ Checking Linear MCP SSE endpoint availability..."
            if command -v curl &> /dev/null; then
                curl -s --max-time 5 https://mcp.linear.app/sse &>/dev/null && {
                    echo "âœ… Linear MCP SSE endpoint is accessible"
                } || {
                    echo "âš ï¸  Could not verify Linear MCP SSE endpoint (may require authentication)"
                }
            else
                echo "âš ï¸  curl not available to test SSE endpoint"
            fi
            ;;
            
        "blz-docs")
            echo "ðŸ” Testing blz-docs MCP server..."
            if ! command -v blz &> /dev/null; then
                echo "âŒ blz CLI required for blz-docs server"
                exit 1
            fi
            
            # Check if blz mcp-server command exists (placeholder)
            echo "ðŸ“š Note: blz mcp-server command not yet implemented"
            echo "   This is planned functionality for future releases"
            ;;
            
        *)
            echo "âš ï¸  Unknown server: $SERVER_NAME"
            echo "   Available servers: linear, blz-docs"
            ;;
    esac
else
    echo "Testing all configured servers..."
    
    # Test Linear server requirements
    echo "ðŸ“ Linear MCP server requirements:"
    if [ -n "${LINEAR_API_KEY:-}" ] && command -v npx &> /dev/null; then
        echo "   âœ… Ready for Linear MCP server"
    else
        echo "   âš ï¸  Missing requirements for Linear MCP server"
    fi
    
    # Test blz-docs server requirements  
    echo "ðŸ“ blz-docs MCP server requirements:"
    if command -v blz &> /dev/null; then
        echo "   âœ… blz CLI available"
        echo "   ðŸ“š Note: mcp-server command not yet implemented"
    else
        echo "   âš ï¸  Missing blz CLI for blz-docs MCP server"
    fi
fi

echo ""
echo "ðŸ“Š Summary:"
echo "- Configuration file: $([ -f ".mcp.json" ] && echo "âœ… Valid" || echo "âŒ Missing/Invalid")"
echo "- Linear requirements: $([ -n "${LINEAR_API_KEY:-}" ] && command -v npx &> /dev/null && echo "âœ… Met" || echo "âš ï¸  Incomplete")"
echo "- blz requirements: $(command -v blz &> /dev/null && echo "âœ… Met" || echo "âš ï¸  Missing")"

echo ""
echo "ðŸš€ MCP server testing completed!"

if [ -f ".mcp.json" ] && [ -n "${LINEAR_API_KEY:-}" ] && command -v npx &> /dev/null; then
    echo "ðŸŽ¯ Ready to use Linear MCP server in Factory!"
else
    echo "âš¡ Some setup steps may be needed before full MCP functionality is available."
fi