#!/usr/bin/env bash
set -euo pipefail

# blz CLI Smoke Test - Quick automated validation
# Usage: /smoke-test [source-name]

echo "ğŸ§ª Running blz CLI smoke tests..."

# Target source for testing (default to first available)
TARGET_SOURCE="${1:-}"

# Check if blz is available
if ! command -v blz &> /dev/null; then
    echo "âŒ blz command not found. Please install blz first."
    exit 1
fi

# Display version
echo "ğŸ“‹ blz version:"
blz --version

# Check basic help
echo "ğŸ“– Testing help output..."
blz --help > /dev/null || {
    echo "âŒ Help command failed"
    exit 1
}

# List available sources
echo "ğŸ“š Available sources:"
SOURCES=$(blz list --json 2>/dev/null | jq -r '.[].name' || blz list | head -5)

if [ -z "$TARGET_SOURCE" ]; then
    # Use first available source
    TARGET_SOURCE=$(echo "$SOURCES" | head -1)
fi

if [ -n "$TARGET_SOURCE" ]; then
    echo "ğŸ¯ Testing with source: $TARGET_SOURCE"
    
    # Test search functionality
    echo "ğŸ” Testing search..."
    blz search "test" --source "$TARGET_SOURCE" --limit 3 > /dev/null || {
        echo "âš ï¸  Search test failed for source: $TARGET_SOURCE"
    }
    
    # Test JSON output
    echo "ğŸ“„ Testing JSON output..."
    blz search "api" --source "$TARGET_SOURCE" --limit 1 --json > /dev/null || {
        echo "âš ï¸  JSON output test failed"
    }
else
    echo "âš ï¸  No sources available for testing"
fi

# Test configuration
echo "âš™ï¸  Testing configuration..."
blz list --json > /dev/null 2>&1 || {
    echo "âš ï¸  Configuration test failed"
}

echo "âœ… Basic smoke tests completed!"
echo ""
echo "ğŸ“Š Summary:"
echo "- blz is accessible and responsive"
echo "- Basic commands work correctly"
echo "- JSON output is functional"
echo "- Configuration is readable"

if [ -n "$TARGET_SOURCE" ]; then
    echo "- Search functionality tested with source: $TARGET_SOURCE"
fi

echo ""
echo "ğŸš€ blz CLI appears to be working correctly!"
